UPDATE EFS_DATA_LAYER.efs_account_dimh d
SET
    d.custom_sort_lvl28 = (SELECT CASE WHEN r.level - 1 = 28 THEN r.SIBLING_SORT_ORDER ELSE null END
                          FROM EFS_RAW.EFS_ACCOUNT_CURRENT_SORT r
                          WHERE d.FIXED_HIER_LEVEL = r.level - 1
                          AND d.ACCOUNT_SEGMENT = r.name
                          AND d.HIERARCHY_VERSION_NAME = 'ACCOUNT_CURRENT'),
    d.custom_sort_lvl29 = (SELECT CASE WHEN r.level - 1 = 29 THEN r.SIBLING_SORT_ORDER ELSE null END
                          FROM EFS_RAW.EFS_ACCOUNT_CURRENT_SORT r
                          WHERE d.FIXED_HIER_LEVEL = r.level - 1
                          AND d.ACCOUNT_SEGMENT = r.name
                          AND d.HIERARCHY_VERSION_NAME = 'ACCOUNT_CURRENT'),
    d.custom_sort_lvl30 = (SELECT CASE WHEN r.level - 1 = 30 THEN r.SIBLING_SORT_ORDER ELSE null END
                          FROM EFS_RAW.EFS_ACCOUNT_CURRENT_SORT r
                          WHERE d.FIXED_HIER_LEVEL = r.level - 1
                          AND d.ACCOUNT_SEGMENT = r.name
                          AND d.HIERARCHY_VERSION_NAME = 'ACCOUNT_CURRENT'),
    d.custom_sort_lvl31 = (SELECT CASE WHEN r.level - 1 = 31 THEN r.SIBLING_SORT_ORDER ELSE null END
                          FROM EFS_RAW.EFS_ACCOUNT_CURRENT_SORT r
                          WHERE d.FIXED_HIER_LEVEL = r.level - 1
                          AND d.ACCOUNT_SEGMENT = r.name
                          AND d.HIERARCHY_VERSION_NAME = 'ACCOUNT_CURRENT')
WHERE EXISTS (SELECT 1 
              FROM EFS_RAW.EFS_ACCOUNT_CURRENT_SORT r
              WHERE d.FIXED_HIER_LEVEL = r.level - 1
              AND d.ACCOUNT_SEGMENT = r.name
              AND d.HIERARCHY_VERSION_NAME = 'ACCOUNT_CURRENT');
