CREATE OR REPLACE PROCEDURE CUSTOM_SORT_1
IS
    CURSOR raw_cursor IS
        SELECT 
            NAME as name,
            LEVEL_1,
            Sibling_Sort_Order as sibling
        FROM EFS_RAW.EFS_ACCOUNT_CURRENT_SORT;

    v_sql VARCHAR2(4000);

BEGIN
    FOR rec IN raw_cursor LOOP
        FOR i IN 1..31 LOOP
            IF rec.level_1 = i THEN
                v_sql := 'UPDATE EFS_DATA_LAYER.efs_account_dimh ' ||
                         'SET custom_sort_lvl_' || TO_CHAR(31 - i + 1) || ' = :1 ' ||
                         'WHERE fixed_hier_level = :2 AND account_segment = :3 AND HIERARCHY_VERSION_NAME = ''Account_Current''';

                EXECUTE IMMEDIATE v_sql USING rec.sibling, TO_CHAR(rec.level_1-1), rec.name;
            END IF;
        END LOOP;
    END LOOP;

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END CUSTOM_SORT_1;
/
