WITH base_data AS (
    SELECT
        Project_ID,
        Version_Number,
        attribut1_date,
        LAG(attribut1_date, 1) OVER (PARTITION BY Project_ID ORDER BY Version_Number) AS prev_attribut1_date,
        LAG(new_eis_date, 1) OVER (PARTITION BY Project_ID ORDER BY Version_Number) AS prev_new_eis_date,
        LAG(last_updated_date, 1) OVER (PARTITION BY Project_ID ORDER BY Version_Number) AS prev_last_updated_date
    FROM
        pjb_temp_table
),
updated_data AS (
    SELECT
        Project_ID,
        Version_Number,
        attribut1_date,
        CASE
            WHEN Version_Number = 1 THEN attribut1_date
            WHEN Version_Number > 1 AND attribut1_date != prev_attribut1_date THEN attribut1_date
            ELSE prev_attribut1_date
        END AS new_eis_date,
        CASE
            WHEN Version_Number = 1 THEN NULL
            ELSE prev_new_eis_date
        END AS old_eis_date,
        CASE
            WHEN Version_Number = 1 THEN attribut1_date
            WHEN Version_Number > 1 AND attribut1_date != prev_attribut1_date THEN attribut1_date
            ELSE prev_last_updated_date
        END AS last_updated_date
    FROM
        base_data
)
SELECT
    Project_ID,
    Version_Number,
    attribut1_date,
    new_eis_date,
    old_eis_date,
    last_updated_date
FROM
    updated_data
ORDER BY
    Project_ID,
    Version_Number;
