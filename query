CREATE OR REPLACE PROCEDURE LoadDimTable
IS
    CURSOR raw_cursor IS
        SELECT level_1, name, sibling, level
        FROM raw_table;

    v_level_1 raw_table.level_1%TYPE;
    v_name raw_table.name%TYPE;
    v_sibling raw_table.sibling%TYPE;
    v_level raw_table.level%TYPE;
    v_sql VARCHAR2(4000);
BEGIN
    FOR rec IN raw_cursor LOOP
        FOR i IN 1..31 LOOP
            IF rec.level_1 = i AND rec.level = 1 THEN
                v_sql := 'UPDATE dim_table ' ||
                         'SET customer_sort_' || TO_CHAR(31 - (i - 1)) || ' = :1 ' ||
                         'WHERE flex = :2 AND account = :3';

                EXECUTE IMMEDIATE v_sql USING rec.sibling, rec.level_1, rec.name;
            ELSIF rec.level_1 = i AND rec.level = 2 THEN
                v_sql := 'UPDATE dim_table ' ||
                         'SET customer_sort_' || TO_CHAR(31 - (i - 2)) || ' = :1 ' ||
                         'WHERE flex = :2 AND account = :3';

                EXECUTE IMMEDIATE v_sql USING rec.sibling, rec.level_1, rec.name;
            END IF;
        END LOOP;
    END LOOP;

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END LoadDimTable;
/
